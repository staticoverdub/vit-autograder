<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoGrader{% if org_name %} - {{ org_name }}{% endif %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tokyo-night-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --accent: #22d3ee;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        * { font-family: 'Inter', sans-serif; }
        code, pre, .mono { font-family: 'JetBrains Mono', monospace; }
        
        body { background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%); }
        
        .bg-grid {
            position: fixed; inset: 0; z-index: 0; pointer-events: none;
            background-image: linear-gradient(rgba(99,102,241,0.03) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(99,102,241,0.03) 1px, transparent 1px);
            background-size: 50px 50px;
        }
        .orb { position: fixed; border-radius: 50%; filter: blur(80px); opacity: 0.3; pointer-events: none; z-index: 0; animation: float 20s ease-in-out infinite; }
        .orb-1 { width: 400px; height: 400px; background: var(--primary); top: -100px; right: -100px; }
        .orb-2 { width: 300px; height: 300px; background: var(--accent); bottom: -50px; left: -50px; animation-delay: -10s; }
        @keyframes float { 0%,100%{transform:translate(0,0)} 50%{transform:translate(20px,-20px)} }
        
        .glass { background: rgba(255,255,255,0.05); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); }
        .glass-card { background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.08); transition: all 0.3s ease; }
        .glass-card:hover { background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04)); transform: translateY(-2px); box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        
        .btn-primary { background: linear-gradient(135deg, var(--primary), #4f46e5); box-shadow: 0 4px 15px rgba(99,102,241,0.3); transition: all 0.3s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(99,102,241,0.4); }
        .btn-success { background: linear-gradient(135deg, var(--success), #059669); box-shadow: 0 4px 15px rgba(16,185,129,0.3); }
        .btn-success:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(16,185,129,0.4); }
        .btn-accent { background: linear-gradient(135deg, var(--accent), #06b6d4); color: #0f172a; }
        
        .nav-item { transition: all 0.2s; position: relative; }
        .nav-item::before { content:''; position:absolute; left:0; top:0; height:100%; width:3px; background:var(--primary); transform:scaleY(0); transition:0.2s; }
        .nav-item:hover { background: rgba(99,102,241,0.1); transform: translateX(4px); }
        .nav-item:hover::before, .nav-item.active::before { transform: scaleY(1); }
        .nav-item.active { background: linear-gradient(90deg, rgba(99,102,241,0.2), transparent); }
        
        .grade-badge { font-weight: 700; width: 3rem; height: 3rem; display: flex; align-items: center; justify-content: center; border-radius: 12px; }
        .grade-badge.excellent { background: linear-gradient(135deg, var(--success), #059669); box-shadow: 0 0 20px rgba(16,185,129,0.4); }
        .grade-badge.good { background: linear-gradient(135deg, var(--warning), #d97706); box-shadow: 0 0 20px rgba(245,158,11,0.4); }
        .grade-badge.needs-work { background: linear-gradient(135deg, var(--danger), #dc2626); box-shadow: 0 0 20px rgba(239,68,68,0.4); }
        
        .fade-in { animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
        .scale-in { animation: scaleIn 0.3s ease; }
        @keyframes scaleIn { from { opacity:0; transform:scale(0.9); } to { opacity:1; transform:scale(1); } }
        
        .spinner { width:40px; height:40px; border:3px solid rgba(99,102,241,0.2); border-top-color:var(--primary); border-radius:50%; animation:spin 0.8s linear infinite; }
        @keyframes spin { to { transform:rotate(360deg); } }
        .progress-bar { background: linear-gradient(90deg, var(--primary), var(--accent), var(--primary)); background-size: 200% 100%; animation: gradient 2s linear infinite; }
        @keyframes gradient { 0%{background-position:0% 50%} 100%{background-position:200% 50%} }
        
        .hljs { background: rgba(15,15,26,0.8) !important; padding: 1.5rem !important; border-radius: 12px !important; }
        ::-webkit-scrollbar { width:6px; height:6px; }
        ::-webkit-scrollbar-track { background:transparent; }
        ::-webkit-scrollbar-thumb { background:rgba(99,102,241,0.3); border-radius:3px; }
        
        .student-card { transition: all 0.2s; border-left: 3px solid transparent; }
        .student-card:hover { background: rgba(99,102,241,0.1); }
        .student-card.selected { background: rgba(99,102,241,0.15); border-left-color: var(--primary); }
        
        .toast { animation: toastIn 0.4s ease; }
        @keyframes toastIn { from { opacity:0; transform:translateY(20px) scale(0.9); } to { opacity:1; transform:translateY(0) scale(1); } }
        
        @keyframes confettiFall { to { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
    </style>
</head>
<body class="text-gray-100 min-h-screen overflow-hidden">
    <div class="bg-grid"></div>
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>

    <div class="flex h-screen relative z-10">
        <!-- Sidebar -->
        <aside class="w-72 glass border-r border-white/5 flex flex-col">
            <div class="p-6 border-b border-white/5">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-xl shadow-lg">üìù</div>
                    <div>
                        <h1 class="text-lg font-bold text-white">AutoGrader</h1>
                        <p class="text-xs text-gray-500">{{ org_tagline or 'AI-Powered Grading' }}</p>
                    </div>
                </div>
            </div>
            
            <nav class="flex-1 p-4 space-y-2">
                <button onclick="showSection('browse')" id="nav-browse" class="nav-item w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 text-gray-400 hover:text-white">
                    <span class="text-xl">üìö</span> <span class="font-medium">Browse Canvas</span>
                </button>
                <button onclick="showSection('upload')" id="nav-upload" class="nav-item w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 text-gray-400 hover:text-white">
                    <span class="text-xl">üìÅ</span> <span class="font-medium">Upload ZIP</span>
                </button>
                <button onclick="showSection('review')" id="nav-review" class="nav-item w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 text-gray-400 hover:text-white">
                    <span class="text-xl">‚ú®</span> <span class="font-medium">Review & Grade</span>
                </button>
                <button onclick="showSection('submit')" id="nav-submit" class="nav-item w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 text-gray-400 hover:text-white">
                    <span class="text-xl">üöÄ</span> <span class="font-medium">Submit to Canvas</span>
                </button>
                <div class="pt-4 border-t border-white/5 mt-4">
                    <button onclick="showSection('dashboard')" id="nav-dashboard" class="nav-item w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 text-gray-400 hover:text-white">
                        <span class="text-xl">üìä</span> <span class="font-medium">Student Dashboard</span>
                    </button>
                </div>
            </nav>
            
            <div class="p-4 border-t border-white/5">
                <div class="glass-card rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                        <span class="text-xs font-medium text-gray-400 uppercase tracking-wider">Session</span>
                    </div>
                    <div id="session-status" class="text-sm space-y-1">
                        <p><span class="text-gray-500">Submissions:</span> <span class="text-white font-medium">0</span></p>
                        <p><span class="text-gray-500">Graded:</span> <span class="text-white font-medium">0</span></p>
                    </div>
                </div>
                <button onclick="openSettings()" class="mt-3 w-full px-4 py-2 rounded-lg text-gray-400 hover:text-white hover:bg-white/5 flex items-center justify-center gap-2 text-sm">
                    <span>‚öôÔ∏è</span> Settings
                </button>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="flex-1 overflow-auto p-8">
            <div class="max-w-7xl mx-auto">
                
                <!-- Browse Canvas -->
                <section id="section-browse" class="hidden fade-in">
                    <div class="flex gap-8">
                        <div class="w-96 flex-shrink-0 space-y-6">
                            <div class="flex items-center justify-between">
                                <h2 class="text-2xl font-bold flex items-center gap-3"><span>üìö</span> Browse Canvas</h2>
                                <button onclick="refreshCanvas()" class="px-4 py-2 glass-card rounded-xl flex items-center gap-2 text-sm hover:bg-white/10">üîÑ Refresh</button>
                            </div>
                            <div class="glass-card rounded-2xl p-6">
                                <h3 class="font-semibold mb-4 text-white">üéì Select Course</h3>
                                <div id="courses-list" class="space-y-2 max-h-48 overflow-auto">
                                    <div class="flex justify-center py-8"><div class="spinner"></div></div>
                                </div>
                            </div>
                            <div id="assignments-container" class="hidden glass-card rounded-2xl p-6 fade-in">
                                <h3 class="font-semibold mb-4 text-white">üìã Select Assignment</h3>
                                <div id="assignments-list" class="space-y-2 max-h-64 overflow-auto"></div>
                            </div>
                        </div>
                        <div id="assignment-summary" class="hidden flex-1 glass-card rounded-2xl p-6 fade-in h-fit">
                            <h3 class="font-semibold mb-4 text-white">üìä Assignment Summary</h3>
                            <div id="assignment-info" class="mb-6 text-gray-300"></div>
                            <div id="grading-type-preview" class="mb-6 p-4 bg-black/20 rounded-xl">
                                <div class="flex items-center gap-3 mb-2">
                                    <span id="grading-type-icon" class="text-2xl">üìù</span>
                                    <div>
                                        <span class="font-semibold text-white" id="grading-type-label">Standard Grading</span>
                                        <p class="text-sm text-gray-400" id="grading-type-source">Loading...</p>
                                    </div>
                                </div>
                                <button onclick="toggleRubricPreview()" class="text-sm text-indigo-400 hover:text-indigo-300 mt-2">Show rubric ‚ñº</button>
                                <div id="rubric-preview-content" class="hidden mt-4 p-4 bg-black/30 rounded-lg text-xs text-gray-300 max-h-48 overflow-auto whitespace-pre-wrap mono"></div>
                            </div>
                            <div class="mb-6">
                                <h4 class="text-sm font-medium text-gray-400 mb-3">Canvas Students</h4>
                                <div id="canvas-students-table" class="max-h-48 overflow-auto bg-black/20 rounded-xl p-4 text-xs mono"></div>
                            </div>
                            <button onclick="downloadFromCanvas()" class="w-full btn-primary text-white px-6 py-4 rounded-xl font-semibold flex items-center justify-center gap-3 text-lg">
                                <span>‚¨áÔ∏è</span> Load Submissions
                            </button>
                        </div>
                    </div>
                </section>
                
                <!-- Upload ZIP -->
                <section id="section-upload" class="hidden fade-in">
                    <div class="max-w-2xl mx-auto">
                        <h2 class="text-2xl font-bold mb-8 flex items-center gap-3"><span>üìÅ</span> Upload ZIP File</h2>
                        <div class="glass-card rounded-2xl p-8">
                            <div id="dropzone" class="border-2 border-dashed border-white/10 rounded-2xl p-12 text-center hover:border-indigo-500/50 hover:bg-indigo-500/5 transition cursor-pointer group"
                                ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="document.getElementById('file-input').click()">
                                <div class="text-6xl mb-4 group-hover:scale-110 transition">üì¶</div>
                                <p class="text-xl font-medium text-white mb-2">Drop your ZIP file here</p>
                                <p class="text-gray-400">or click to browse</p>
                                <input type="file" id="file-input" accept=".zip" class="hidden" onchange="handleFileSelect(event)">
                            </div>
                            <div id="file-info" class="hidden mt-6 p-4 bg-black/20 rounded-xl fade-in">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">üìÑ</span>
                                    <div class="flex-1">
                                        <p id="file-name" class="font-medium text-white"></p>
                                        <p id="file-size" class="text-sm text-gray-400"></p>
                                    </div>
                                    <button onclick="processZip()" class="btn-success text-white px-6 py-2 rounded-lg font-medium">Process</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Review & Grade -->
                <section id="section-review" class="hidden fade-in">
                    <div class="flex gap-6 h-[calc(100vh-8rem)]">
                        <div class="w-80 flex-shrink-0 flex flex-col glass-card rounded-2xl p-4">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-lg font-bold flex items-center gap-2">üë• Submissions <span id="submission-count" class="text-sm font-normal text-gray-500">(0)</span></h2>
                            </div>
                            <button onclick="gradeAllSubmissions()" class="mb-4 w-full btn-primary text-white px-4 py-3 rounded-xl font-medium flex items-center justify-center gap-2">
                                <span>ü§ñ</span> Grade All with AI
                            </button>
                            <input type="text" id="student-search" placeholder="üîç Search..." oninput="filterStudents(this.value)"
                                class="mb-4 w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-indigo-500">
                            <div id="quick-stats" class="grid grid-cols-3 gap-2 mb-4">
                                <div class="bg-green-500/10 border border-green-500/20 rounded-lg p-2 text-center">
                                    <div class="text-lg font-bold text-green-400" id="stat-excellent">0</div>
                                    <div class="text-xs text-green-400/70">9-10</div>
                                </div>
                                <div class="bg-yellow-500/10 border border-yellow-500/20 rounded-lg p-2 text-center">
                                    <div class="text-lg font-bold text-yellow-400" id="stat-good">0</div>
                                    <div class="text-xs text-yellow-400/70">7-8</div>
                                </div>
                                <div class="bg-red-500/10 border border-red-500/20 rounded-lg p-2 text-center">
                                    <div class="text-lg font-bold text-red-400" id="stat-needs-work">0</div>
                                    <div class="text-xs text-red-400/70">&lt;7</div>
                                </div>
                            </div>
                            <div id="student-list" class="flex-1 overflow-auto space-y-2">
                                <p class="text-gray-500 text-center py-8">No submissions loaded</p>
                            </div>
                        </div>
                        
                        <div class="flex-1 flex flex-col glass-card rounded-2xl overflow-hidden">
                            <div class="p-4 border-b border-white/5 flex items-center justify-between bg-black/20">
                                <div>
                                    <h3 id="student-detail-name" class="font-semibold text-lg text-white">Select a student</h3>
                                    <p id="student-detail-file" class="text-sm text-gray-400 mono"></p>
                                    <p id="student-detail-submitted" class="text-xs text-gray-500 mt-1"></p>
                                </div>
                                <div class="flex items-center gap-3">
                                    <button onclick="gradeCurrentStudent()" class="btn-primary text-white px-4 py-2 rounded-xl flex items-center gap-2 text-sm font-medium">ü§ñ Grade This</button>
                                    <button onclick="runCurrentCode()" class="btn-success text-white px-4 py-2 rounded-xl flex items-center gap-2 text-sm font-medium">‚ñ∂Ô∏è Run</button>
                                    <button onclick="skipCurrentSubmission()" class="px-3 py-2 text-gray-400 hover:text-yellow-400 glass-card rounded-lg text-sm" title="Skip - remove from current batch">‚è≠Ô∏è</button>
                                    <div class="relative group">
                                        <button class="px-3 py-2 text-gray-400 hover:text-white glass-card rounded-lg">‚ö†Ô∏è</button>
                                        <div class="absolute right-0 top-full pt-2 w-64 hidden group-hover:block z-10">
                                          <div class="bg-gray-900/95 backdrop-blur border border-white/10 rounded-xl overflow-hidden">
                                            <p class="px-4 py-2 text-xs font-semibold text-gray-400 border-b border-white/5">Wrong File Actions</p>
                                            <button onclick="markSubmissionMissing()" class="w-full px-4 py-3 text-left text-sm hover:bg-white/10 flex items-center gap-2">
                                                <span>üì≠</span> Mark as Missing
                                                <span class="text-xs text-gray-500 ml-auto">in Canvas</span>
                                            </button>
                                            <button onclick="excuseSubmission()" class="w-full px-4 py-3 text-left text-sm hover:bg-white/10 flex items-center gap-2 border-t border-white/5">
                                                <span>‚úñÔ∏è</span> Excuse Submission
                                                <span class="text-xs text-gray-500 ml-auto">no grade impact</span>
                                            </button>
                                          </div>
                                        </div>
                                    </div>
                                    <div class="relative group">
                                        <button class="px-3 py-2 text-gray-400 hover:text-white glass-card rounded-lg">üìö</button>
                                        <div class="absolute right-0 top-full pt-2 w-72 hidden group-hover:block z-10">
                                          <div class="bg-gray-900/95 backdrop-blur border border-white/10 rounded-xl p-4 text-xs">
                                            <p class="font-semibold mb-2 text-white">Available Libraries:</p>
                                            <p class="text-gray-400">{{ available_libraries | join(', ') if available_libraries else 'requests, json, openpyxl, pandas, numpy, matplotlib, math, random, datetime, os, re' }}</p>
                                          </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex-1 flex overflow-hidden">
                                <div class="flex-1 overflow-auto p-4">
                                    <pre id="code-viewer" class="text-sm"><code class="language-python">Select a student to view code</code></pre>
                                </div>
                                <div class="w-80 border-l border-white/5 flex flex-col bg-black/20">
                                    <div class="p-3 border-b border-white/5"><span class="text-xs font-semibold text-gray-400 uppercase">Output</span></div>
                                    <pre id="code-output" class="flex-1 overflow-auto p-4 text-sm mono text-gray-400">Run code to see output</pre>
                                </div>
                            </div>
                            <div class="p-4 border-t border-white/5 bg-black/20">
                                <div class="flex gap-6">
                                    <div class="flex-1">
                                        <div class="flex items-center justify-between mb-2">
                                            <label class="text-sm font-medium text-gray-300">Grade</label>
                                            <div id="grade-badge" class="grade-badge excellent text-lg">10</div>
                                        </div>
                                        <input type="range" id="grade-slider" min="0" max="10" step="0.5" value="10" class="w-full h-2 bg-white/10 rounded-full appearance-none cursor-pointer" oninput="updateGradeBadge(this.value)">
                                    </div>
                                    <div class="w-64">
                                        <label class="text-sm font-medium text-gray-300 block mb-2">Quick Submit</label>
                                        <div class="flex gap-2">
                                            <select id="canvas-user-select" class="flex-1 bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-sm"><option value="">Select...</option></select>
                                            <button onclick="submitSingleGrade()" class="btn-accent px-4 py-2 rounded-lg text-sm font-medium">Send</button>
                                        </div>
                                        <p id="single-submit-result" class="mt-1 text-xs text-center"></p>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <label class="text-sm font-medium text-gray-300">Comment</label>
                                        <div class="flex gap-1">
                                            <button onclick="setComment('Great work! üåü')" class="px-2 py-1 text-xs bg-white/5 hover:bg-white/10 rounded">Great!</button>
                                            <button onclick="setComment('Good effort! Add more comments to your code.')" class="px-2 py-1 text-xs bg-white/5 hover:bg-white/10 rounded">Add comments</button>
                                        </div>
                                    </div>
                                    <textarea id="grade-comment" rows="2" class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-sm resize-none focus:outline-none" placeholder="Add feedback..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Submit to Canvas -->
                <section id="section-submit" class="hidden fade-in">
                    <div class="max-w-3xl mx-auto">
                        <div class="flex items-center justify-between mb-8">
                            <h2 class="text-2xl font-bold flex items-center gap-3"><span>üöÄ</span> Submit to Canvas</h2>
                            <button onclick="refreshSubmitPanel()" class="px-4 py-2 glass-card rounded-xl flex items-center gap-2 text-sm hover:bg-white/10">üîÑ Refresh</button>
                        </div>
                        <div class="glass-card rounded-2xl p-8 mb-6">
                            <div class="grid grid-cols-3 gap-4 mb-8">
                                <div class="glass-card rounded-xl p-5 text-center border-t-2 border-indigo-500">
                                    <div class="text-4xl font-bold text-white" id="total-submissions">0</div>
                                    <div class="text-sm text-gray-400 mt-1">Total</div>
                                </div>
                                <div class="glass-card rounded-xl p-5 text-center border-t-2 border-green-500">
                                    <div class="text-4xl font-bold text-green-400" id="graded-count">0</div>
                                    <div class="text-sm text-gray-400 mt-1">Graded</div>
                                </div>
                                <div class="glass-card rounded-xl p-5 text-center border-t-2 border-cyan-500">
                                    <div class="text-4xl font-bold text-cyan-400" id="avg-grade">-</div>
                                    <div class="text-sm text-gray-400 mt-1">Average</div>
                                </div>
                            </div>
                            <div class="mb-6">
                                <h4 class="text-sm font-medium text-gray-400 mb-3">Grades Ready to Submit</h4>
                                <div id="pending-grades-list" class="max-h-48 overflow-auto bg-black/20 rounded-xl p-4 text-sm">
                                    <p class="text-gray-500 text-center py-4">No grades pending</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-400">Course ID</label>
                                    <input type="text" id="submit-course-id" class="w-full bg-black/30 border border-white/10 rounded-xl p-4 focus:outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-400">Assignment ID</label>
                                    <input type="text" id="submit-assignment-id" class="w-full bg-black/30 border border-white/10 rounded-xl p-4 focus:outline-none">
                                </div>
                            </div>
                            <button onclick="submitToCanvas()" class="w-full btn-primary text-white px-6 py-4 rounded-xl font-semibold flex items-center justify-center gap-3 text-lg">
                                <span>üì§</span> Submit All Grades
                            </button>
                        </div>
                        <div id="submit-results" class="hidden glass-card rounded-2xl p-6 fade-in">
                            <h3 class="font-semibold mb-4 text-white">Results</h3>
                            <div id="results-list" class="space-y-2 max-h-96 overflow-auto"></div>
                        </div>
                    </div>
                </section>
                
                <!-- Student Dashboard -->
                <section id="section-dashboard" class="hidden fade-in">
                    <div class="max-w-6xl mx-auto">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold flex items-center gap-3"><span>üìä</span> Student Dashboard</h2>
                            <button onclick="refreshDashboard()" class="px-4 py-2 glass-card rounded-xl flex items-center gap-2 text-sm hover:bg-white/10">üîÑ Refresh</button>
                        </div>
                        
                        <div class="glass-card rounded-2xl p-6 mb-6">
                            <label class="block text-sm font-medium mb-3 text-gray-400">Select Course</label>
                            <select id="dashboard-course-select" onchange="loadStudentDashboard(this.value)" class="w-full bg-black/30 border border-white/10 rounded-xl p-4 text-white focus:outline-none">
                                <option value="">Select a course...</option>
                            </select>
                        </div>
                        
                        <!-- Disclaimer -->
                        <div id="dashboard-disclaimer" class="hidden mb-6 p-4 bg-blue-500/10 border border-blue-500/20 rounded-xl text-sm text-blue-300 flex items-center gap-3">
                            <span class="text-xl">‚ÑπÔ∏è</span>
                            <span>Showing students with 5+ completed assignments. <span id="inactive-count-text"></span></span>
                        </div>
                        
                        <div id="dashboard-content" class="hidden space-y-6 fade-in">
                            <!-- Stats Overview -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="glass-card rounded-xl p-5 text-center border-t-2 border-indigo-500">
                                    <div class="text-3xl font-bold text-white" id="dash-total-students">0</div>
                                    <div class="text-sm text-gray-400">Active Students</div>
                                </div>
                                <div class="glass-card rounded-xl p-5 text-center border-t-2 border-green-500">
                                    <div class="text-3xl font-bold text-green-400" id="dash-complete">0</div>
                                    <div class="text-sm text-gray-400">Completed</div>
                                </div>
                                <div class="glass-card rounded-xl p-5 text-center border-t-2 border-yellow-500">
                                    <div class="text-3xl font-bold text-yellow-400" id="dash-in-progress">0</div>
                                    <div class="text-sm text-gray-400">In Progress</div>
                                </div>
                                <div class="glass-card rounded-xl p-5 text-center border-t-2 border-cyan-500">
                                    <div class="text-3xl font-bold text-cyan-400" id="dash-celebrated">0</div>
                                    <div class="text-sm text-gray-400">Celebrated</div>
                                </div>
                            </div>
                            
                            <!-- Visualizations Row -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Completion Donut -->
                                <div class="glass-card rounded-2xl p-6">
                                    <h3 class="font-semibold text-white mb-4">üìà Class Completion</h3>
                                    <div class="flex items-center justify-center">
                                        <div class="relative">
                                            <svg width="180" height="180" id="completion-donut">
                                                <circle cx="90" cy="90" r="70" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="20"/>
                                                <circle cx="90" cy="90" r="70" fill="none" stroke="url(#donutGradient)" stroke-width="20" 
                                                    stroke-dasharray="440" stroke-dashoffset="440" stroke-linecap="round"
                                                    transform="rotate(-90 90 90)" id="completion-circle"/>
                                                <defs>
                                                    <linearGradient id="donutGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                                        <stop offset="0%" style="stop-color:#6366f1"/>
                                                        <stop offset="100%" style="stop-color:#22d3ee"/>
                                                    </linearGradient>
                                                </defs>
                                            </svg>
                                            <div class="absolute inset-0 flex items-center justify-center flex-col">
                                                <span class="text-3xl font-bold text-white" id="completion-percent">0%</span>
                                                <span class="text-xs text-gray-400">Complete</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Grade Distribution -->
                                <div class="glass-card rounded-2xl p-6">
                                    <h3 class="font-semibold text-white mb-4">üìä Grade Distribution</h3>
                                    <div class="space-y-3" id="grade-distribution-bars">
                                        <div class="flex items-center gap-3">
                                            <span class="text-sm w-20 text-gray-400">9-10 ‚≠ê</span>
                                            <div class="flex-1 h-6 bg-white/10 rounded-full overflow-hidden">
                                                <div class="h-full bg-gradient-to-r from-green-500 to-emerald-400 rounded-full transition-all duration-500" id="bar-excellent" style="width:0%"></div>
                                            </div>
                                            <span class="text-sm w-8 text-right text-white" id="count-excellent">0</span>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <span class="text-sm w-20 text-gray-400">7-8 üëç</span>
                                            <div class="flex-1 h-6 bg-white/10 rounded-full overflow-hidden">
                                                <div class="h-full bg-gradient-to-r from-yellow-500 to-amber-400 rounded-full transition-all duration-500" id="bar-good" style="width:0%"></div>
                                            </div>
                                            <span class="text-sm w-8 text-right text-white" id="count-good">0</span>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <span class="text-sm w-20 text-gray-400">&lt;7 üìö</span>
                                            <div class="flex-1 h-6 bg-white/10 rounded-full overflow-hidden">
                                                <div class="h-full bg-gradient-to-r from-red-500 to-rose-400 rounded-full transition-all duration-500" id="bar-needs-work" style="width:0%"></div>
                                            </div>
                                            <span class="text-sm w-8 text-right text-white" id="count-needs-work">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Insights Alert Box -->
                            <div id="insights-box" class="hidden glass-card rounded-2xl p-4 border border-yellow-500/30 bg-yellow-500/10">
                                <h3 class="font-semibold text-yellow-400 mb-2">‚ö†Ô∏è Insights</h3>
                                <div id="insights-list" class="space-y-2 text-sm"></div>
                            </div>
                            
                            <!-- Quick Actions Summary -->
                            <div class="grid grid-cols-2 gap-4">
                                <div class="glass-card rounded-xl p-4 text-center">
                                    <div class="text-3xl font-bold text-yellow-400" id="needs-reminder-count">0</div>
                                    <div class="text-xs text-gray-400">Need Reminders</div>
                                </div>
                                <div class="glass-card rounded-xl p-4 text-center">
                                    <div class="text-3xl font-bold text-green-400" id="ready-celebrate-count">0</div>
                                    <div class="text-xs text-gray-400">Ready to Celebrate</div>
                                </div>
                            </div>
                            
                            <!-- Assignment Health - Now with dual bars -->
                            <div class="glass-card rounded-2xl p-6">
                                <h3 class="font-semibold text-white mb-2">üìä Assignment Performance</h3>
                                <p class="text-xs text-gray-400 mb-4">Completion rate (blue) vs Average score (green) - in course order</p>
                                <div id="assignment-health" class="space-y-3"></div>
                            </div>
                            
                            <!-- Student Table -->
                            <div class="glass-card rounded-2xl p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-semibold text-white">üë• Students</h3>
                                    <div class="flex gap-2">
                                        <input type="text" id="student-filter" placeholder="üîç Search..." oninput="filterDashboardStudents(this.value)"
                                            class="bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-sm w-48 focus:outline-none">
                                        <select id="student-sort" onchange="sortDashboardStudents(this.value)" class="bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-sm">
                                            <option value="progress-desc">Progress ‚Üì</option>
                                            <option value="progress-asc">Progress ‚Üë</option>
                                            <option value="grade-desc">Grade ‚Üì</option>
                                            <option value="grade-asc">Grade ‚Üë</option>
                                            <option value="name-asc">Name A-Z</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Bulk Actions -->
                                <div class="flex gap-2 mb-4">
                                    <button onclick="remindAllIncomplete()" class="px-4 py-2 bg-yellow-500/20 hover:bg-yellow-500/30 border border-yellow-500/30 text-yellow-400 rounded-lg text-sm font-medium flex items-center gap-2">
                                        <span>üìß</span> Remind All Incomplete
                                    </button>
                                    <button onclick="celebrateAllComplete()" class="px-4 py-2 bg-green-500/20 hover:bg-green-500/30 border border-green-500/30 text-green-400 rounded-lg text-sm font-medium flex items-center gap-2">
                                        <span>üéâ</span> Celebrate All Complete
                                    </button>
                                    <div class="flex-1"></div>
                                    <button onclick="testReminderToTeachers()" class="px-3 py-2 bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/30 text-purple-400 rounded-lg text-xs font-medium">
                                        üß™ Test Reminder
                                    </button>
                                    <button onclick="testCelebrationToTeachers()" class="px-3 py-2 bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/30 text-purple-400 rounded-lg text-xs font-medium">
                                        üß™ Test Congrats
                                    </button>
                                </div>
                                </div>
                                
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm">
                                        <thead>
                                            <tr class="text-left text-gray-400 border-b border-white/10">
                                                <th class="pb-3 font-medium">Student</th>
                                                <th class="pb-3 font-medium">Progress</th>
                                                <th class="pb-3 font-medium">Avg Grade</th>
                                                <th class="pb-3 font-medium">Missing</th>
                                                <th class="pb-3 font-medium text-right">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="student-table-body" class="divide-y divide-white/5">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="glass-card rounded-2xl p-8 text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p id="loading-text" class="text-lg font-medium text-white">Loading...</p>
            <div class="w-64 h-1 bg-white/10 rounded-full mt-4 overflow-hidden"><div class="progress-bar h-full rounded-full"></div></div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="glass-card rounded-2xl p-8 w-full max-w-lg scale-in">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-white">‚öôÔ∏è Settings</h2>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="space-y-5">
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-300">Canvas URL</label>
                    <input type="text" id="settings-canvas-url" disabled class="w-full bg-black/30 border border-white/10 rounded-xl p-4 text-gray-400">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-300">Canvas API Token</label>
                    <div id="settings-canvas-token-status" class="text-sm text-gray-400 p-4 bg-black/30 border border-white/10 rounded-xl"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-300">Anthropic API Key</label>
                    <div id="settings-anthropic-key-status" class="text-sm text-gray-400 p-4 bg-black/30 border border-white/10 rounded-xl"></div>
                </div>
                <p class="text-xs text-gray-500 mt-2">Credentials are configured via .env file and config.yaml</p>
            </div>
            <div class="flex gap-3 mt-8">
                <button onclick="closeSettings()" class="flex-1 px-4 py-3 rounded-xl border border-white/10 hover:bg-white/5">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-50 space-y-3"></div>
    
    <!-- Celebration Preview Modal -->
    <div id="celebration-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-8">
        <div class="glass-card rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden scale-in">
            <div class="flex items-center justify-between p-6 border-b border-white/5">
                <h2 class="text-xl font-bold text-white">üéâ Preview</h2>
                <button onclick="closeCelebrationPreview()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="celebration-preview-content" class="p-6 overflow-auto max-h-96"></div>
            <div class="p-6 border-t border-white/5 flex justify-end gap-3">
                <button onclick="closeCelebrationPreview()" class="px-6 py-3 rounded-xl border border-white/10 hover:bg-white/5">Cancel</button>
                <button id="send-celebration-btn" class="btn-success text-white px-6 py-3 rounded-xl font-medium">Send</button>
            </div>
        </div>
    </div>

    <script>
        // State
        let currentSubmissions = [];
        let currentGrades = [];
        let selectedStudentIndex = -1;
        let selectedCourse = null;
        let selectedAssignment = null;
        let canvasStudents = [];
        let dashboardCourseId = null;
        
        // Sound Effects
        function playSound(type) {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                if (type === 'success') {
                    osc.frequency.setValueAtTime(523, ctx.currentTime);
                    osc.frequency.setValueAtTime(659, ctx.currentTime + 0.1);
                    osc.frequency.setValueAtTime(784, ctx.currentTime + 0.2);
                    gain.gain.setValueAtTime(0.3, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
                    osc.start(); osc.stop(ctx.currentTime + 0.4);
                } else if (type === 'click') {
                    osc.frequency.setValueAtTime(800, ctx.currentTime);
                    gain.gain.setValueAtTime(0.1, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.05);
                    osc.start(); osc.stop(ctx.currentTime + 0.05);
                } else if (type === 'complete') {
                    [440, 554, 659, 880].forEach((f, i) => {
                        osc.frequency.setValueAtTime(f, ctx.currentTime + i * 0.15);
                    });
                    gain.gain.setValueAtTime(0.3, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.6);
                    osc.start(); osc.stop(ctx.currentTime + 0.6);
                }
            } catch(e) {}
        }
        
        function createConfetti() {
            const colors = ['#6366f1', '#22d3ee', '#10b981', '#f59e0b', '#ec4899'];
            for (let i = 0; i < 50; i++) {
                const c = document.createElement('div');
                c.style.cssText = `position:fixed;width:${Math.random()*10+5}px;height:${Math.random()*10+5}px;background:${colors[Math.floor(Math.random()*5)]};left:${Math.random()*100}vw;top:-20px;border-radius:${Math.random()>0.5?'50%':'0'};pointer-events:none;z-index:1000;animation:confettiFall ${Math.random()*2+2}s linear forwards;`;
                document.body.appendChild(c);
                setTimeout(() => c.remove(), 4000);
            }
        }
        
        // UI Helpers
        function showLoading(text = 'Loading...') {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        function hideLoading() { document.getElementById('loading-overlay').classList.add('hidden'); }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = { info: 'from-indigo-500/20 border-indigo-500/30', success: 'from-green-500/20 border-green-500/30', error: 'from-red-500/20 border-red-500/30', warning: 'from-yellow-500/20 border-yellow-500/30' };
            toast.className = `toast glass px-6 py-4 rounded-xl bg-gradient-to-r ${colors[type]} border shadow-lg max-w-sm`;
            toast.innerHTML = `<p class="text-sm font-medium text-white">${message}</p>`;
            container.appendChild(toast);
            if (type === 'success') playSound('success');
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 4000);
        }
        
        function showSection(section) {
            try {
                playSound('click');
                document.querySelectorAll('main section').forEach(s => s.classList.add('hidden'));
                const sectionEl = document.getElementById(`section-${section}`);
                if (sectionEl) sectionEl.classList.remove('hidden');
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active', 'text-white'));
                const navEl = document.getElementById(`nav-${section}`);
                if (navEl) navEl.classList.add('active', 'text-white');
                if (section === 'browse') loadCourses();
                if (section === 'dashboard') populateDashboardCourses();
                if (section === 'submit') updatePendingGradesList();
            } catch(e) { console.error('showSection error:', e); }
        }
        
        function escapeHtml(text) { const d = document.createElement('div'); d.textContent = text; return d.innerHTML; }
        
        // Settings
        function openSettings() { playSound('click'); loadSettings(); document.getElementById('settings-modal').classList.remove('hidden'); }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
        
        async function loadSettings() {
            try {
                const res = await fetch('/api/config');
                const cfg = await res.json();
                document.getElementById('settings-canvas-url').value = cfg.canvas_url || '';
                document.getElementById('settings-canvas-token-status').textContent = cfg.has_token ? 'Configured' : 'Not set ‚Äî add CANVAS_TOKEN to .env';
                document.getElementById('settings-anthropic-key-status').textContent = cfg.has_anthropic ? 'Configured' : 'Not set ‚Äî add ANTHROPIC_API_KEY to .env';
            } catch(e) {}
        }
        
        // Canvas Integration
        async function loadCourses() {
            try {
                const res = await fetch('/api/courses');
                const courses = await res.json();
                const list = document.getElementById('courses-list');
                if (courses.length === 0) { list.innerHTML = '<p class="text-gray-500 text-center py-4">No courses found</p>'; return; }
                
                // Show courses immediately
                list.innerHTML = courses.map(c => `<button onclick="selectCourse(${c.id}, '${escapeHtml(c.name).replace(/'/g, "&#39;")}')" class="w-full text-left p-3 rounded-xl hover:bg-white/5 transition flex items-center gap-3 group" id="course-btn-${c.id}"><span class="text-xl">üìò</span><span class="text-sm text-gray-300 group-hover:text-white truncate flex-1">${escapeHtml(c.name)}</span><span class="text-xs text-gray-500" id="course-count-${c.id}">...</span></button>`).join('');
                
                // Fetch grading counts for each course in background
                for (const c of courses) {
                    fetch(`/api/courses/${c.id}/assignments`).then(r => r.json()).then(assignments => {
                        const total = assignments.reduce((sum, a) => sum + (a.needs_grading_count || 0), 0);
                        const el = document.getElementById(`course-count-${c.id}`);
                        if (el) {
                            if (total > 0) {
                                el.innerHTML = `<span class="px-2 py-1 bg-yellow-500/20 text-yellow-400 rounded-lg font-bold">${total}</span>`;
                            } else {
                                el.innerHTML = `<span class="text-green-400">‚úì</span>`;
                            }
                        }
                    }).catch(() => {});
                }
            } catch(e) { document.getElementById('courses-list').innerHTML = '<p class="text-red-400 text-center py-4">Error loading</p>'; }
        }
        
        let currentAssignments = []; // Store assignments for lookup
        
        async function selectCourse(id, name) {
            playSound('click');
            selectedCourse = { id, name };
            document.getElementById('assignments-container').classList.remove('hidden');
            document.getElementById('assignment-summary').classList.add('hidden');
            document.getElementById('assignments-list').innerHTML = '<div class="flex justify-center py-4"><div class="spinner"></div></div>';
            try {
                const res = await fetch(`/api/courses/${id}/assignments`);
                const assignments = await res.json();
                currentAssignments = assignments; // Store for later lookup
                
                // Sort: needs grading first, then by name
                assignments.sort((a, b) => {
                    const aNeeds = a.needs_grading_count || 0;
                    const bNeeds = b.needs_grading_count || 0;
                    if (bNeeds !== aNeeds) return bNeeds - aNeeds;
                    return a.name.localeCompare(b.name);
                });
                
                // Calculate totals
                const totalNeedsGrading = assignments.reduce((sum, a) => sum + (a.needs_grading_count || 0), 0);
                
                let html = '';
                if (totalNeedsGrading > 0) {
                    html += `<div class="mb-3 p-3 bg-yellow-500/10 border border-yellow-500/20 rounded-xl text-sm"><span class="text-yellow-400 font-semibold">${totalNeedsGrading}</span> <span class="text-yellow-400/70">submissions need grading</span></div>`;
                }
                
                html += assignments.map(a => {
                    const needsGrading = a.needs_grading_count || 0;
                    const points = a.points_possible || 10;
                    const badge = needsGrading > 0 
                        ? `<span class="px-2 py-1 bg-yellow-500/20 text-yellow-400 text-xs font-bold rounded-lg">${needsGrading}</span>`
                        : `<span class="px-2 py-1 bg-green-500/20 text-green-400 text-xs rounded-lg">‚úì</span>`;
                    return `<button onclick="selectAssignment(${a.id}, '${escapeHtml(a.name).replace(/'/g, "&#39;")}', ${points})" class="w-full text-left p-3 rounded-xl hover:bg-white/5 transition flex items-center gap-3 group"><span class="text-lg">üìÑ</span><span class="text-sm text-gray-300 group-hover:text-white truncate flex-1">${escapeHtml(a.name)}</span><span class="text-xs text-gray-500">${points}pts</span>${badge}</button>`;
                }).join('');
                
                document.getElementById('assignments-list').innerHTML = html;
            } catch(e) { document.getElementById('assignments-list').innerHTML = '<p class="text-red-400">Error</p>'; }
        }
        
        async function selectAssignment(id, name, pointsPossible = 10) {
            playSound('click');
            selectedAssignment = { id, name, points_possible: pointsPossible };
            document.getElementById('submit-course-id').value = selectedCourse.id;
            document.getElementById('submit-assignment-id').value = id;
            document.getElementById('assignment-summary').classList.remove('hidden');
            document.getElementById('assignment-info').innerHTML = `<p class="text-sm"><span class="text-gray-500">Course:</span> ${escapeHtml(selectedCourse.name)}</p><p class="text-sm mt-1"><span class="text-gray-500">Assignment:</span> ${escapeHtml(name)} <span class="text-gray-400">(${pointsPossible} points)</span></p>`;
            
            // Update grade slider max
            const slider = document.getElementById('grade-slider');
            slider.max = pointsPossible;
            slider.value = pointsPossible;
            updateGradeBadge(pointsPossible);
            
            try {
                const rubricRes = await fetch(`/api/courses/${selectedCourse.id}/rubric-preview?assignment=${encodeURIComponent(name)}`);
                const rubricData = await rubricRes.json();
                const icons = { checkoff: '‚úÖ', final_project: 'üéì', standard: 'üìù' };
                const labels = { checkoff: 'Auto Check-off', final_project: 'Final Project', standard: 'AI Grading' };
                document.getElementById('grading-type-icon').textContent = icons[rubricData.assignment_type] || 'üìù';
                document.getElementById('grading-type-label').textContent = labels[rubricData.assignment_type] || 'Standard';
                document.getElementById('grading-type-source').textContent = `Source: ${rubricData.source}`;
                document.getElementById('rubric-preview-content').textContent = rubricData.rubric || 'No details';
            } catch(e) {}
            
            try {
                const res = await fetch(`/api/courses/${selectedCourse.id}/assignments/${id}/canvas-students`);
                canvasStudents = await res.json();
                const table = document.getElementById('canvas-students-table');
                table.innerHTML = `<table class="w-full"><thead><tr class="text-left text-gray-500 border-b border-white/10"><th class="pb-2">Name</th><th class="pb-2">Status</th></tr></thead><tbody>${canvasStudents.map(s => {
                    let status = '', cls = '';
                    if (s.graded) { status = `‚úÖ ${s.score||'Graded'}`; cls = 'text-green-400'; }
                    else if (s.has_submission) { status = 'üìù Needs grading'; cls = 'text-yellow-400'; }
                    else { status = '‚è≥ No submission'; cls = 'text-gray-500'; }
                    return `<tr class="border-b border-white/5"><td class="py-2 text-gray-300">${escapeHtml(s.name)}</td><td class="py-2 ${cls}">${status}</td></tr>`;
                }).join('')}</tbody></table><div class="mt-3 pt-3 border-t border-white/5 text-xs text-gray-500">${canvasStudents.filter(s=>s.graded).length} graded ‚Ä¢ ${canvasStudents.filter(s=>s.has_submission&&!s.graded).length} needs grading</div>`;
                populateCanvasUserDropdown();
            } catch(e) {}
        }
        
        function toggleRubricPreview() { document.getElementById('rubric-preview-content').classList.toggle('hidden'); }
        function refreshCanvas() { selectedCourse = null; selectedAssignment = null; document.getElementById('assignments-container').classList.add('hidden'); document.getElementById('assignment-summary').classList.add('hidden'); currentSubmissions = []; updateSessionStatus(); loadCourses(); showToast('üîÑ Refreshed!', 'info'); }
        
        async function downloadFromCanvas() {
            showLoading('Downloading...');
            try {
                const res = await fetch(`/api/courses/${selectedCourse.id}/assignments/${selectedAssignment.id}/download-submissions`);
                const data = await res.json();
                if (data.error) { hideLoading(); showToast('Error: ' + data.error, 'error'); return; }
                currentSubmissions = data.submissions || [];
                const skipped = [];
                if (data.skipped_graded > 0) skipped.push(`${data.skipped_graded} graded`);
                if (data.skipped_no_submission > 0) skipped.push(`${data.skipped_no_submission} no submission`);
                if (currentSubmissions.length === 0) { hideLoading(); showToast('No ungraded submissions' + (skipped.length ? ` (${skipped.join(', ')})` : ''), 'warning'); return; }
                updateSessionStatus(); hideLoading();
                showToast(`Loaded ${currentSubmissions.length} submissions` + (skipped.length ? ` (skipped: ${skipped.join(', ')})` : ''), 'success');
                showSection('review'); renderStudentList();
            } catch(e) { hideLoading(); showToast('Error: ' + e.message, 'error'); }
        }
        
        // File Upload
        function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('border-indigo-500/50', 'bg-indigo-500/10'); }
        function handleDragLeave(e) { e.currentTarget.classList.remove('border-indigo-500/50', 'bg-indigo-500/10'); }
        function handleDrop(e) { e.preventDefault(); e.currentTarget.classList.remove('border-indigo-500/50', 'bg-indigo-500/10'); const f = e.dataTransfer.files[0]; if (f && f.name.endsWith('.zip')) showFileInfo(f); else showToast('Please upload a ZIP', 'error'); }
        function handleFileSelect(e) { const f = e.target.files[0]; if (f) showFileInfo(f); }
        function showFileInfo(file) { document.getElementById('file-info').classList.remove('hidden'); document.getElementById('file-name').textContent = file.name; document.getElementById('file-size').textContent = (file.size/1024).toFixed(1) + ' KB'; window.selectedFile = file; playSound('click'); }
        
        async function processZip() {
            if (!window.selectedFile) return;
            showLoading('Processing...');
            const formData = new FormData(); formData.append('file', window.selectedFile);
            try {
                const res = await fetch('/api/upload', { method: 'POST', body: formData });
                const data = await res.json();
                if (data.error) { hideLoading(); showToast('Error: ' + data.error, 'error'); return; }
                currentSubmissions = data.submissions || [];
                updateSessionStatus(); hideLoading();
                showToast(`Loaded ${currentSubmissions.length} submissions`, 'success');
                showSection('review'); renderStudentList();
            } catch(e) { hideLoading(); showToast('Error', 'error'); }
        }
        
        // Grading
        function renderStudentList() {
            const list = document.getElementById('student-list');
            document.getElementById('submission-count').textContent = `(${currentSubmissions.length})`;
            if (currentSubmissions.length === 0) { list.innerHTML = '<p class="text-gray-500 text-center py-8">No submissions</p>'; return; }
            list.innerHTML = currentSubmissions.map((sub, idx) => {
                const grade = sub.grade_info?.grade;
                const hasGrade = grade !== undefined;
                const cls = hasGrade ? (grade >= 9 ? 'excellent' : grade >= 7 ? 'good' : 'needs-work') : '';
                return `<div onclick="selectStudent(${idx})" class="student-card p-3 rounded-xl cursor-pointer flex items-center gap-3 ${idx === selectedStudentIndex ? 'selected' : ''}">${hasGrade ? `<div class="grade-badge ${cls} text-sm">${grade}</div>` : `<div class="w-12 h-12 rounded-xl bg-white/5 flex items-center justify-center text-gray-500">?</div>`}<div class="flex-1 min-w-0"><p class="font-medium text-white truncate">${escapeHtml(sub.student_name)}</p><p class="text-xs text-gray-500 mono truncate">${escapeHtml(sub.filename)}</p></div></div>`;
            }).join('');
            updateGradeStats();
        }
        
        function filterStudents(q) { q = q.toLowerCase(); currentSubmissions.forEach((s, i) => { const card = document.querySelectorAll('.student-card')[i]; if (card) card.style.display = (s.student_name.toLowerCase().includes(q) || s.filename.toLowerCase().includes(q)) ? '' : 'none'; }); }
        
        function selectStudent(idx) {
            playSound('click');
            selectedStudentIndex = idx;
            const sub = currentSubmissions[idx];
            document.querySelectorAll('.student-card').forEach((c, i) => c.classList.toggle('selected', i === idx));
            document.getElementById('student-detail-name').textContent = sub.student_name;
            document.getElementById('student-detail-file').textContent = sub.filename;
            
            // Display submission date/time
            const submittedEl = document.getElementById('student-detail-submitted');
            if (sub.submitted_at) {
                const date = new Date(sub.submitted_at);
                submittedEl.textContent = `üìÖ Submitted: ${date.toLocaleDateString()} at ${date.toLocaleTimeString()}`;
            } else {
                submittedEl.textContent = '';
            }
            
            document.getElementById('code-viewer').innerHTML = `<code class="language-python">${escapeHtml(sub.code || '# No code')}</code>`;
            hljs.highlightAll();
            document.getElementById('code-output').innerHTML = sub.run_result ? `<span class="text-green-400">${escapeHtml(sub.run_result.output || '')}</span>${sub.run_result.errors ? `<span class="text-red-400">\n${escapeHtml(sub.run_result.errors)}</span>` : ''}` : 'Run code to see output';
            const maxPoints = selectedAssignment?.points_possible || 10;
            if (sub.grade_info) { document.getElementById('grade-slider').value = sub.grade_info.grade || maxPoints; document.getElementById('grade-comment').value = sub.grade_info.comment || ''; updateGradeBadge(sub.grade_info.grade || maxPoints); }
            else { document.getElementById('grade-slider').value = maxPoints; document.getElementById('grade-comment').value = ''; updateGradeBadge(maxPoints); }
            populateCanvasUserDropdown();
        }
        
        function updateGradeBadge(val) {
            const badge = document.getElementById('grade-badge');
            const maxPoints = selectedAssignment?.points_possible || 10;
            const pct = (val / maxPoints) * 100;
            badge.textContent = val;
            badge.className = 'grade-badge text-lg ' + (pct >= 90 ? 'excellent' : pct >= 70 ? 'good' : 'needs-work');
            if (selectedStudentIndex >= 0 && currentSubmissions[selectedStudentIndex]) {
                if (!currentSubmissions[selectedStudentIndex].grade_info) currentSubmissions[selectedStudentIndex].grade_info = {};
                currentSubmissions[selectedStudentIndex].grade_info.grade = parseFloat(val);
                currentSubmissions[selectedStudentIndex].grade_info.comment = document.getElementById('grade-comment').value;
            }
        }
        
        function setComment(text) { document.getElementById('grade-comment').value = text; if (selectedStudentIndex >= 0 && currentSubmissions[selectedStudentIndex]?.grade_info) currentSubmissions[selectedStudentIndex].grade_info.comment = text; }
        
        function updateGradeStats() {
            const graded = currentSubmissions.filter(s => s.grade_info?.grade !== undefined);
            const maxPoints = selectedAssignment?.points_possible || 10;
            document.getElementById('stat-excellent').textContent = graded.filter(s => (s.grade_info.grade / maxPoints) >= 0.9).length;
            document.getElementById('stat-good').textContent = graded.filter(s => (s.grade_info.grade / maxPoints) >= 0.7 && (s.grade_info.grade / maxPoints) < 0.9).length;
            document.getElementById('stat-needs-work').textContent = graded.filter(s => (s.grade_info.grade / maxPoints) < 0.7).length;
        }
        
        async function runCurrentCode() {
            if (selectedStudentIndex < 0) return;
            const sub = currentSubmissions[selectedStudentIndex];
            document.getElementById('code-output').innerHTML = '<span class="text-gray-400">Running...</span>';
            try {
                const res = await fetch('/api/run-code', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ code: sub.code }) });
                const result = await res.json();
                sub.run_result = result;
                document.getElementById('code-output').innerHTML = `<span class="text-green-400">${escapeHtml(result.output || '')}</span>${result.errors ? `<span class="text-red-400">\n${escapeHtml(result.errors)}</span>` : ''}`;
                if (result.success) playSound('success');
            } catch(e) { document.getElementById('code-output').innerHTML = `<span class="text-red-400">Error: ${escapeHtml(e.message)}</span>`; }
        }
        
        async function gradeCurrentStudent() {
            if (selectedStudentIndex < 0) return;
            const sub = currentSubmissions[selectedStudentIndex];
            const maxPoints = selectedAssignment?.points_possible || 10;
            showLoading(`Grading ${sub.student_name}...`);
            try {
                if (!sub.run_result) { const r = await fetch('/api/run-code', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ code: sub.code }) }); sub.run_result = await r.json(); }
                const res = await fetch('/api/grade-single', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ assignment_name: selectedAssignment?.name || '', points_possible: maxPoints, submission: sub }) });
                const data = await res.json();
                if (data.error) { hideLoading(); showToast('Error: ' + data.error, 'error'); return; }
                sub.grade_info = data.grade;
                hideLoading(); updateSessionStatus(); renderStudentList(); selectStudent(selectedStudentIndex);
                showToast(`‚úÖ Graded ${sub.student_name}: ${data.grade.grade}/${maxPoints}`, 'success');
            } catch(e) { hideLoading(); showToast('Error: ' + e.message, 'error'); }
        }
        
        async function gradeAllSubmissions() {
            if (currentSubmissions.length === 0) { showToast('No submissions', 'warning'); return; }
            const ungraded = currentSubmissions.filter(s => !s.grade_info);
            if (ungraded.length === 0) { showToast('All graded!', 'info'); return; }
            if (!confirm(`Grade ${ungraded.length} submissions?`)) return;
            const maxPoints = selectedAssignment?.points_possible || 10;
            showLoading(`Grading...`);
            try {
                let count = 0;
                for (const sub of ungraded) {
                    showLoading(`Grading ${++count}/${ungraded.length}: ${sub.student_name}...`);
                    if (sub.code && !sub.run_result) { const r = await fetch('/api/run-code', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ code: sub.code }) }); sub.run_result = await r.json(); }
                    const res = await fetch('/api/grade-single', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ assignment_name: selectedAssignment?.name || '', points_possible: maxPoints, submission: { student_name: sub.student_name, filename: sub.filename, code: sub.code, run_result: sub.run_result } }) });
                    if (res.ok) { const data = await res.json(); if (data.grade) sub.grade_info = data.grade; }
                }
                hideLoading(); updateSessionStatus(); renderStudentList(); if (selectedStudentIndex >= 0) selectStudent(selectedStudentIndex);
                playSound('complete'); createConfetti();
                showToast(`‚úÖ Graded ${count} submissions!`, 'success');
            } catch(e) { hideLoading(); showToast('Error: ' + e.message, 'error'); }
        }

        // Skip/Excuse submission actions
        function skipCurrentSubmission() {
            if (selectedStudentIndex < 0) return;
            const sub = currentSubmissions[selectedStudentIndex];
            if (!confirm(`Skip "${sub.student_name}"? This removes them from the current batch (no Canvas changes).`)) return;
            currentSubmissions.splice(selectedStudentIndex, 1);
            selectedStudentIndex = -1;
            updateSessionStatus();
            renderStudentList();
            document.getElementById('student-detail-name').textContent = 'Select a student';
            document.getElementById('student-detail-file').textContent = '';
            document.getElementById('code-viewer').innerHTML = '<code class="language-python">Select a student to view code</code>';
            showToast(`‚è≠Ô∏è Skipped ${sub.student_name}`, 'info');
        }

        async function markSubmissionMissing() {
            if (selectedStudentIndex < 0) return;
            if (!selectedCourse || !selectedAssignment) { showToast('No course/assignment selected', 'warning'); return; }
            const sub = currentSubmissions[selectedStudentIndex];
            if (!sub.user_id) { showToast('No Canvas user ID for this submission', 'warning'); return; }
            if (!confirm(`Mark "${sub.student_name}" as MISSING in Canvas?\n\nThis indicates they submitted the wrong file and need to resubmit.`)) return;
            showLoading('Marking as missing...');
            try {
                const res = await fetch(`/api/courses/${selectedCourse.id}/assignments/${selectedAssignment.id}/submissions/${sub.user_id}/mark-missing`, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    currentSubmissions.splice(selectedStudentIndex, 1);
                    selectedStudentIndex = -1;
                    updateSessionStatus();
                    renderStudentList();
                    document.getElementById('student-detail-name').textContent = 'Select a student';
                    document.getElementById('student-detail-file').textContent = '';
                    document.getElementById('code-viewer').innerHTML = '<code class="language-python">Select a student to view code</code>';
                    hideLoading();
                    showToast(`üì≠ Marked ${sub.student_name} as missing`, 'success');
                } else {
                    hideLoading();
                    showToast('Error: ' + (data.error || 'Failed'), 'error');
                }
            } catch(e) { hideLoading(); showToast('Error: ' + e.message, 'error'); }
        }

        async function excuseSubmission() {
            if (selectedStudentIndex < 0) return;
            if (!selectedCourse || !selectedAssignment) { showToast('No course/assignment selected', 'warning'); return; }
            const sub = currentSubmissions[selectedStudentIndex];
            if (!sub.user_id) { showToast('No Canvas user ID for this submission', 'warning'); return; }
            if (!confirm(`Excuse "${sub.student_name}" in Canvas?\n\nThis removes the assignment from their grade calculation entirely.`)) return;
            showLoading('Excusing submission...');
            try {
                const res = await fetch(`/api/courses/${selectedCourse.id}/assignments/${selectedAssignment.id}/submissions/${sub.user_id}/excuse`, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    currentSubmissions.splice(selectedStudentIndex, 1);
                    selectedStudentIndex = -1;
                    updateSessionStatus();
                    renderStudentList();
                    document.getElementById('student-detail-name').textContent = 'Select a student';
                    document.getElementById('student-detail-file').textContent = '';
                    document.getElementById('code-viewer').innerHTML = '<code class="language-python">Select a student to view code</code>';
                    hideLoading();
                    showToast(`‚úñÔ∏è Excused ${sub.student_name}`, 'success');
                } else {
                    hideLoading();
                    showToast('Error: ' + (data.error || 'Failed'), 'error');
                }
            } catch(e) { hideLoading(); showToast('Error: ' + e.message, 'error'); }
        }

        // Canvas Submit
        function populateCanvasUserDropdown() {
            const sel = document.getElementById('canvas-user-select');
            sel.innerHTML = '<option value="">Select...</option>' + canvasStudents.map(s => `<option value="${s.user_id}">${escapeHtml(s.name)}</option>`).join('');
            if (selectedStudentIndex >= 0 && currentSubmissions[selectedStudentIndex]) {
                const sub = currentSubmissions[selectedStudentIndex];
                const match = canvasStudents.find(s => s.user_id === sub.user_id);
                if (match) sel.value = match.user_id;
            }
        }
        
        async function submitSingleGrade() {
            const courseId = document.getElementById('submit-course-id').value || selectedCourse?.id;
            const assignmentId = document.getElementById('submit-assignment-id').value || selectedAssignment?.id;
            const userId = document.getElementById('canvas-user-select').value;
            if (!courseId || !assignmentId) { showToast('Select course/assignment', 'warning'); return; }
            if (!userId) { showToast('Select student', 'warning'); return; }
            const grade = document.getElementById('grade-slider').value;
            const comment = document.getElementById('grade-comment').value;
            const el = document.getElementById('single-submit-result');
            el.textContent = 'Submitting...'; el.className = 'mt-1 text-xs text-center text-gray-400';
            try {
                const res = await fetch('/api/submit-single-grade', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ course_id: courseId, assignment_id: assignmentId, user_id: userId, grade, comment }) });
                if (!res.ok) throw new Error('Server error');
                const data = await res.json();
                if (data.success) { el.textContent = '‚úÖ Submitted!'; el.className = 'mt-1 text-xs text-center text-green-400'; playSound('success'); }
                else { el.textContent = '‚ùå ' + (data.error || 'Failed'); el.className = 'mt-1 text-xs text-center text-red-400'; }
            } catch(e) { el.textContent = '‚ùå ' + e.message; el.className = 'mt-1 text-xs text-center text-red-400'; }
        }
        
        function updateSessionStatus() {
            const graded = currentSubmissions.filter(s => s.grade_info?.grade !== undefined).length;
            document.getElementById('session-status').innerHTML = `<p><span class="text-gray-500">Submissions:</span> <span class="text-white font-medium">${currentSubmissions.length}</span></p><p><span class="text-gray-500">Graded:</span> <span class="text-white font-medium">${graded}</span></p>`;
            document.getElementById('total-submissions').textContent = currentSubmissions.length;
            document.getElementById('graded-count').textContent = graded;
            document.getElementById('avg-grade').textContent = graded > 0 ? (currentSubmissions.filter(s => s.grade_info?.grade !== undefined).reduce((a, s) => a + parseFloat(s.grade_info.grade), 0) / graded).toFixed(1) : '-';
            updateGradeStats(); updatePendingGradesList();
        }
        
        function updatePendingGradesList() {
            const container = document.getElementById('pending-grades-list');
            if (!container) return;
            const graded = currentSubmissions.filter(s => s.grade_info?.grade !== undefined);
            if (graded.length === 0) { container.innerHTML = '<p class="text-gray-500 text-center py-4">No grades pending</p>'; return; }
            container.innerHTML = graded.map(s => `<div class="flex items-center justify-between py-2 border-b border-white/5 last:border-0"><span class="truncate flex-1 text-gray-300">${escapeHtml(s.student_name)}</span><span class="ml-2 px-2 py-1 rounded-lg text-xs font-bold ${s.grade_info.grade >= 9 ? 'bg-green-500/20 text-green-400' : s.grade_info.grade >= 7 ? 'bg-yellow-500/20 text-yellow-400' : 'bg-red-500/20 text-red-400'}">${s.grade_info.grade}/10</span></div>`).join('');
        }
        
        function refreshSubmitPanel() { updateSessionStatus(); updatePendingGradesList(); document.getElementById('submit-results').classList.add('hidden'); showToast(`üîÑ ${currentSubmissions.filter(s => s.grade_info?.grade !== undefined).length} grades ready`, 'info'); }
        
        async function submitToCanvas() {
            const courseId = document.getElementById('submit-course-id').value;
            const assignmentId = document.getElementById('submit-assignment-id').value;
            if (!courseId || !assignmentId) { showToast('Enter IDs', 'warning'); return; }
            const grades = currentSubmissions.filter(s => s.grade_info?.grade !== undefined).map(s => ({ student_name: s.student_name, filename: s.filename, user_id: s.user_id, grade: s.grade_info.grade, comment: s.grade_info.comment || '' }));
            if (grades.length === 0) { showToast('No grades', 'warning'); return; }
            showLoading('Submitting...');
            try {
                const res = await fetch('/api/submit-grades', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ course_id: courseId, assignment_id: assignmentId, grades }) });
                if (!res.ok) throw new Error('Server error');
                const data = await res.json();
                hideLoading();
                if (data.error) { showToast('Error: ' + data.error, 'error'); return; }
                document.getElementById('submit-results').classList.remove('hidden');
                document.getElementById('results-list').innerHTML = (data.results || []).map(r => `<div class="flex items-center gap-3 p-3 rounded-xl ${r.success ? 'bg-green-500/10 border border-green-500/20' : 'bg-red-500/10 border border-red-500/20'}"><span class="text-xl">${r.success ? '‚úÖ' : '‚ùå'}</span><span class="flex-1 text-gray-300">${escapeHtml(r.student)}</span><span class="mono font-bold ${r.success ? 'text-green-400' : 'text-red-400'}">${r.grade}/10</span></div>`).join('');
                const success = data.results?.filter(r => r.success).length || 0;
                if (success > 0) { playSound('complete'); createConfetti(); }
                showToast(`Submitted ${success}/${grades.length}!`, success > 0 ? 'success' : 'error');
            } catch(e) { hideLoading(); showToast('Error: ' + e.message, 'error'); }
        }
        
        // Dashboard
        let dashboardData = null;
        
        async function populateDashboardCourses() {
            try {
                const res = await fetch('/api/courses');
                const courses = await res.json();
                document.getElementById('dashboard-course-select').innerHTML = '<option value="">Select a course...</option>' + courses.map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
            } catch(e) {}
        }
        
        async function loadStudentDashboard(courseId) {
            if (!courseId) { document.getElementById('dashboard-content').classList.add('hidden'); document.getElementById('dashboard-disclaimer').classList.add('hidden'); return; }
            dashboardCourseId = courseId;
            
            // Check if we have preloaded data
            if (preloadedDashboardData[courseId]) {
                console.log('Using preloaded dashboard data');
                dashboardData = preloadedDashboardData[courseId];
                delete preloadedDashboardData[courseId]; // Clear after use
                renderDashboard();
                return;
            }
            
            showLoading('Loading student data...');
            try {
                const res = await fetch(`/api/courses/${courseId}/student-dashboard`);
                dashboardData = await res.json();
                hideLoading();
                if (dashboardData.error) { showToast('Error: ' + dashboardData.error, 'error'); return; }
                renderDashboard();
            } catch(e) { hideLoading(); showToast('Error: ' + e.message, 'error'); console.error(e); }
        }
        
        function renderDashboard() {
            document.getElementById('dashboard-content').classList.remove('hidden');
            
            // Show disclaimer with inactive count
            const inactiveCount = dashboardData.inactive_count || 0;
            if (inactiveCount > 0) {
                document.getElementById('dashboard-disclaimer').classList.remove('hidden');
                document.getElementById('inactive-count-text').textContent = `${inactiveCount} student${inactiveCount !== 1 ? 's' : ''} with fewer assignments not shown.`;
            } else {
                document.getElementById('dashboard-disclaimer').classList.add('hidden');
            }
            
            // Update stats with safe defaults
            document.getElementById('dash-total-students').textContent = dashboardData.active_students || 0;
            document.getElementById('dash-complete').textContent = dashboardData.complete_count || 0;
            document.getElementById('dash-in-progress').textContent = (dashboardData.active_students || 0) - (dashboardData.complete_count || 0);
            document.getElementById('dash-celebrated').textContent = dashboardData.celebrated_count || 0;
            
            // Update completion donut
            const completionPercent = dashboardData.completion_rate || 0;
            const circumference = 440;
            const offset = circumference - (completionPercent / 100) * circumference;
            document.getElementById('completion-circle').style.strokeDashoffset = offset;
            document.getElementById('completion-percent').textContent = Math.round(completionPercent) + '%';
            
            // Update grade distribution bars
            const dist = dashboardData.grade_distribution || {excellent: 0, good: 0, needs_work: 0, ungraded: 0};
            const total = (dist.excellent || 0) + (dist.good || 0) + (dist.needs_work || 0) + (dist.ungraded || 0) || 1;
            document.getElementById('bar-excellent').style.width = ((dist.excellent || 0) / total * 100) + '%';
            document.getElementById('bar-good').style.width = ((dist.good || 0) / total * 100) + '%';
            document.getElementById('bar-needs-work').style.width = ((dist.needs_work || 0) / total * 100) + '%';
            document.getElementById('count-excellent').textContent = dist.excellent || 0;
            document.getElementById('count-good').textContent = dist.good || 0;
            document.getElementById('count-needs-work').textContent = dist.needs_work || 0;
            
            // Assignment health
            const stats = dashboardData.assignment_stats || [];
            
            // Render assignment health with dual bars (completion + avg score)
            const healthHtml = stats.length > 0 ? stats.map((a, idx) => {
                const rate = a.completion_rate || 0;
                const avgScore = a.avg_score;
                const hasScore = avgScore !== null && avgScore !== undefined;
                
                // Color coding for completion
                const compColor = rate >= 80 ? '#10b981' : rate >= 50 ? '#f59e0b' : '#ef4444';
                // Color coding for score
                const scoreColor = hasScore ? (avgScore >= 80 ? '#10b981' : avgScore >= 60 ? '#f59e0b' : '#ef4444') : '#6b7280';
                
                // Truncate long names
                const shortName = a.name.length > 25 ? a.name.substring(0, 22) + '...' : a.name;

                return `<div class="flex items-center gap-3 p-2 rounded-lg bg-white/5 hover:bg-white/10 transition-colors">
                    <div class="w-8 text-xs text-gray-500 text-right">${idx + 1}.</div>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm text-white truncate mb-1" title="${escapeHtml(a.name)}">${escapeHtml(shortName)}</div>
                        <div class="flex gap-1 h-4">
                            <div class="flex-1 bg-black/30 rounded-full overflow-hidden" title="Completion: ${Math.round(rate)}%">
                                <div class="h-full rounded-full transition-all" style="width: ${rate}%; background: ${compColor}"></div>
                            </div>
                            <div class="flex-1 bg-black/30 rounded-full overflow-hidden" title="Avg Score: ${hasScore ? Math.round(avgScore) + '%' : 'N/A'}">
                                <div class="h-full rounded-full transition-all" style="width: ${hasScore ? avgScore : 0}%; background: ${scoreColor}"></div>
                            </div>
                        </div>
                    </div>
                    <div class="text-right w-24">
                        <div class="text-xs" style="color: ${compColor}">${Math.round(rate)}% done</div>
                        <div class="text-xs" style="color: ${scoreColor}">${hasScore ? Math.round(avgScore) + '% avg' : '‚Äî'}</div>
                    </div>
                </div>`;
            }).join('') : '<p class="text-gray-500 text-center py-4">No assignments found</p>';
            document.getElementById('assignment-health').innerHTML = healthHtml;
            
            // Render insights
            const insights = dashboardData.insights || [];
            const insightsBox = document.getElementById('insights-box');
            const insightsList = document.getElementById('insights-list');
            if (insights.length > 0) {
                insightsBox.classList.remove('hidden');
                insightsList.innerHTML = insights.map(i => {
                    const icon = i.severity === 'danger' ? 'üî¥' : 'üü°';
                    return `<div class="flex items-start gap-2">
                        <span>${icon}</span>
                        <span class="text-gray-300">${escapeHtml(i.message)}</span>
                    </div>`;
                }).join('');
            } else {
                insightsBox.classList.add('hidden');
            }
            
            // Update action counts
            document.getElementById('needs-reminder-count').textContent = dashboardData.needs_reminder || 0;
            document.getElementById('ready-celebrate-count').textContent = dashboardData.ready_to_celebrate || 0;
            
            // Student table
            const students = dashboardData.students || [];
            if (students.length > 0) {
                renderStudentTable(students);
            } else {
                document.getElementById('student-table-body').innerHTML = '<tr><td colspan="5" class="py-8 text-center text-gray-500">No students with 5+ completed assignments found</td></tr>';
            }
        }
        
        function refreshDashboard() {
            if (dashboardCourseId) {
                loadStudentDashboard(dashboardCourseId);
                showToast('üîÑ Dashboard refreshed!', 'info');
            } else {
                showToast('Select a course first', 'warning');
            }
        }
        
        function renderStudentTable(students) {
            const tbody = document.getElementById('student-table-body');
            if (!students || students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="py-8 text-center text-gray-500">No students found</td></tr>';
                return;
            }
            
            // Store student data for lookup
            window.studentDataMap = {};
            students.forEach(s => { window.studentDataMap[s.user_id] = s; });
            
            tbody.innerHTML = students.map(s => {
                const name = s.name || 'Unknown';
                const progressPercent = s.progress_percent || 0;
                const avgGrade = s.avg_grade || 0;
                const missing = s.missing || [];
                const completed = s.completed || 0;
                const total = s.total || 0;
                
                const progressColor = progressPercent >= 100 ? 'green' : progressPercent >= 50 ? 'yellow' : 'red';
                const progressBar = `<div class="w-24 h-2 bg-white/10 rounded-full overflow-hidden"><div class="h-full rounded-full" style="width:${progressPercent}%; background-color: ${progressColor === 'green' ? '#10b981' : progressColor === 'yellow' ? '#f59e0b' : '#ef4444'}"></div></div>`;
                const missingText = missing.length > 0 ? `<span class="text-yellow-400">${missing.length} missing</span>` : '<span class="text-green-400">‚úì Complete</span>';
                const missingTooltip = missing.length > 0 ? `title="${missing.join(', ').replace(/"/g, '&quot;')}"` : '';
                
                let actions = '';
                if (s.is_complete && !s.celebrated) {
                    actions = `<button onclick="celebrateStudent(${s.user_id})" class="px-3 py-1 bg-green-500/20 hover:bg-green-500/30 text-green-400 rounded-lg text-xs font-medium">üéâ Celebrate!</button>`;
                } else if (s.is_complete && s.celebrated) {
                    actions = `<span class="text-gray-500 text-xs">‚úÖ Celebrated</span>`;
                } else if (!s.is_complete) {
                    actions = `<button onclick="remindStudent(${s.user_id})" class="px-3 py-1 bg-yellow-500/20 hover:bg-yellow-500/30 text-yellow-400 rounded-lg text-xs font-medium" ${s.reminded_recently ? 'disabled title="Already reminded recently"' : ''}>üìß Remind</button>`;
                }
                
                const gradeColor = avgGrade >= 9 ? '#10b981' : avgGrade >= 7 ? '#f59e0b' : '#9ca3af';
                
                return `<tr class="student-row" data-name="${escapeHtml(name.toLowerCase())}" data-progress="${progressPercent}" data-grade="${avgGrade}">
                    <td class="py-3"><span class="text-white font-medium">${escapeHtml(name)}</span></td>
                    <td class="py-3"><div class="flex items-center gap-2">${progressBar}<span class="text-xs text-gray-400">${completed}/${total}</span></div></td>
                    <td class="py-3"><span class="font-medium" style="color: ${gradeColor}">${avgGrade > 0 ? avgGrade.toFixed(1) : '-'}</span></td>
                    <td class="py-3" ${missingTooltip}>${missingText}</td>
                    <td class="py-3 text-right">${actions}</td>
                </tr>`;
            }).join('');
        }
        
        function filterDashboardStudents(query) {
            const q = query.toLowerCase();
            document.querySelectorAll('.student-row').forEach(row => {
                row.style.display = row.dataset.name.includes(q) ? '' : 'none';
            });
        }
        
        function sortDashboardStudents(sortBy) {
            if (!dashboardData) return;
            let students = [...dashboardData.students];
            switch(sortBy) {
                case 'progress-desc': students.sort((a,b) => b.progress_percent - a.progress_percent); break;
                case 'progress-asc': students.sort((a,b) => a.progress_percent - b.progress_percent); break;
                case 'grade-desc': students.sort((a,b) => b.avg_grade - a.avg_grade); break;
                case 'grade-asc': students.sort((a,b) => a.avg_grade - b.avg_grade); break;
                case 'name-asc': students.sort((a,b) => a.name.localeCompare(b.name)); break;
            }
            renderStudentTable(students);
        }
        
        async function celebrateStudent(userId) {
            if (!dashboardCourseId) return;
            const student = window.studentDataMap[userId];
            const name = student?.name || 'Student';
            showLoading(`Sending celebration to ${name}...`);
            try {
                const res = await fetch(`/api/courses/${dashboardCourseId}/send-celebration/${userId}`, { method: 'POST' });
                const data = await res.json();
                hideLoading();
                if (data.success) { playSound('complete'); createConfetti(); showToast(`üéâ Celebration sent to ${name}!`, 'success'); loadStudentDashboard(dashboardCourseId); }
                else showToast('Error: ' + (data.error || 'Failed'), 'error');
            } catch(e) { hideLoading(); showToast('Error: ' + e.message, 'error'); }
        }
        
        async function remindStudent(userId) {
            if (!dashboardCourseId) return;
            const student = window.studentDataMap[userId];
            const name = student?.name || 'Student';
            const missing = student?.missing || [];
            showLoading(`Sending reminder to ${name}...`);
            try {
                const res = await fetch(`/api/courses/${dashboardCourseId}/send-reminder/${userId}`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ missing: missing })
                });
                const data = await res.json();
                hideLoading();
                if (data.success) { playSound('success'); showToast(`üìß Reminder sent to ${name}!`, 'success'); loadStudentDashboard(dashboardCourseId); }
                else showToast('Error: ' + (data.error || 'Failed'), 'error');
            } catch(e) { hideLoading(); showToast('Error: ' + e.message, 'error'); }
        }
        
        async function testReminderToTeachers() {
            if (!dashboardCourseId) { showToast('Select a course first', 'warning'); return; }
            showLoading('Sending test reminder to teachers...');
            try {
                const res = await fetch(`/api/courses/${dashboardCourseId}/test-reminder`, { method: 'POST' });
                const data = await res.json();
                hideLoading();
                if (data.success) { 
                    playSound('success'); 
                    showToast(`‚úÖ Test reminder sent to teachers!`, 'success'); 
                } else {
                    showToast('Error: ' + (data.error || 'Failed'), 'error');
                }
            } catch(e) { hideLoading(); showToast('Error: ' + e.message, 'error'); }
        }
        
        async function testCelebrationToTeachers() {
            if (!dashboardCourseId) { showToast('Select a course first', 'warning'); return; }
            showLoading('Sending test celebration to teachers...');
            try {
                const res = await fetch(`/api/courses/${dashboardCourseId}/test-celebration`, { method: 'POST' });
                const data = await res.json();
                hideLoading();
                if (data.success) { 
                    playSound('success'); 
                    showToast(`‚úÖ Test celebration sent to teachers!`, 'success'); 
                } else {
                    showToast('Error: ' + (data.error || 'Failed'), 'error');
                }
            } catch(e) { hideLoading(); showToast('Error: ' + e.message, 'error'); }
        }
        
        async function remindAllIncomplete() {
            if (!dashboardData || !dashboardCourseId) return;
            const incomplete = dashboardData.students.filter(s => !s.is_complete && !s.reminded_recently);
            if (incomplete.length === 0) { showToast('No students to remind', 'info'); return; }
            if (!confirm(`Send reminders to ${incomplete.length} students?`)) return;
            showLoading('Sending reminders...');
            let sent = 0, failed = 0;
            for (const s of incomplete) {
                try {
                    const res = await fetch(`/api/courses/${dashboardCourseId}/send-reminder/${s.user_id}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ missing: s.missing })
                    });
                    const data = await res.json();
                    if (data.success) sent++; else failed++;
                } catch(e) { failed++; }
            }
            hideLoading();
            if (sent > 0) playSound('complete');
            showToast(`üìß Sent: ${sent} | ‚ùå Failed: ${failed}`, sent > 0 ? 'success' : 'error');
            loadStudentDashboard(dashboardCourseId);
        }
        
        async function celebrateAllComplete() {
            if (!dashboardData || !dashboardCourseId) return;
            const eligible = dashboardData.students.filter(s => s.is_complete && !s.celebrated);
            if (eligible.length === 0) { showToast('No students to celebrate', 'info'); return; }
            if (!confirm(`Send celebrations to ${eligible.length} students?`)) return;
            showLoading('Sending celebrations...');
            let sent = 0, failed = 0;
            for (const s of eligible) {
                try {
                    const res = await fetch(`/api/courses/${dashboardCourseId}/send-celebration/${s.user_id}`, { method: 'POST' });
                    const data = await res.json();
                    if (data.success) sent++; else failed++;
                } catch(e) { failed++; }
            }
            hideLoading();
            if (sent > 0) { playSound('complete'); createConfetti(); }
            showToast(`üéâ Sent: ${sent} | ‚ùå Failed: ${failed}`, sent > 0 ? 'success' : 'error');
            loadStudentDashboard(dashboardCourseId);
        }
        
        // Init
        let preloadedDashboardData = {};
        
        document.addEventListener('DOMContentLoaded', () => { 
            console.log('AutoGrader initialized');
            showSection('browse');
            // Preload dashboard data in background
            preloadDashboardData();
        });
        
        async function preloadDashboardData() {
            try {
                const coursesRes = await fetch('/api/courses');
                const courses = await coursesRes.json();
                // Preload first course's dashboard data
                if (courses.length > 0) {
                    console.log('Preloading dashboard for:', courses[0].name);
                    const dashRes = await fetch(`/api/courses/${courses[0].id}/student-dashboard`);
                    preloadedDashboardData[courses[0].id] = await dashRes.json();
                    console.log('Dashboard preloaded');
                }
            } catch(e) { console.log('Preload failed (non-critical):', e); }
        }
    </script>
</body>
</html>
